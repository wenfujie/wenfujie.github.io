<!DOCTYPE html><html lang="zh-TW" data-theme="light"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>webpack热更新原理 | 温富杰 blog</title><meta name="description" content="webpack热更新原理"><meta name="keywords" content="webpack"><meta name="author" content="温富杰"><meta name="copyright" content="温富杰"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://s2.ax1x.com/2020/03/01/3caYmF.png"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="http://ta.qq.com"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="webpack热更新原理"><meta name="twitter:description" content="webpack热更新原理"><meta name="twitter:image" content="https://z3.ax1x.com/2021/03/24/6b40k4.jpg"><meta property="og:type" content="article"><meta property="og:title" content="webpack热更新原理"><meta property="og:url" content="http://wenf.top/2021/03/24/webpack热更新原理/"><meta property="og:site_name" content="温富杰 blog"><meta property="og:description" content="webpack热更新原理"><meta property="og:image" content="https://z3.ax1x.com/2021/03/24/6b40k4.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'true'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://wenf.top/2021/03/24/webpack热更新原理/"><link rel="next" title="http协议" href="http://wenf.top/2021/03/22/http协议/"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: '',
  enable_page_level_ads: 'true'
});</script><script src="http://tajs.qq.com/stats?sId=66524452" charset="UTF-8"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查詢的內容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"http://wenf.top/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '複製成功',
    error: '複製錯誤',
    noSupport: '瀏覽器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '鍵將本頁加入書籤'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">温富杰 blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娛樂</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/photos/"><i class="fa-fw fa fa-file-image-o"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 電影</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://s2.ax1x.com/2020/02/29/3yUm5t.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">22</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">標籤</div><div class="length_num">15</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分類</div><div class="length_num">3</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娛樂</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/photos/"><i class="fa-fw fa fa-file-image-o"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 電影</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目錄</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#前言"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#热更新实现原理"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">热更新实现原理</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-webpack-dev-server启动本地服务"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">1. webpack-dev-server启动本地服务</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-修改webpack-config-js的entry配置"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">2. 修改webpack.config.js的entry配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-监听webpack编译结束"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">3. 监听webpack编译结束</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#4-webpack监听文件变化"><span class="toc_mobile_items-number">2.4.</span> <span class="toc_mobile_items-text">4. webpack监听文件变化</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#5-浏览器接收到热更新的通知"><span class="toc_mobile_items-number">2.5.</span> <span class="toc_mobile_items-text">5. 浏览器接收到热更新的通知</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#6-HotModuleReplacementPlugin"><span class="toc_mobile_items-number">2.6.</span> <span class="toc_mobile_items-text">6. HotModuleReplacementPlugin</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#7-moudle-hot-check-开始热更新"><span class="toc_mobile_items-number">2.7.</span> <span class="toc_mobile_items-text">7. moudle.hot.check 开始热更新</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#8-hotApply-热更新模块替换"><span class="toc_mobile_items-number">2.8.</span> <span class="toc_mobile_items-text">8. hotApply 热更新模块替换</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#①删除过期的模块，就是需要替换的模块"><span class="toc_mobile_items-number">2.8.1.</span> <span class="toc_mobile_items-text">①删除过期的模块，就是需要替换的模块</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#②将新的模块添加到-modules-中"><span class="toc_mobile_items-number">2.8.2.</span> <span class="toc_mobile_items-text">②将新的模块添加到 modules 中</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#③通过-webpack-require-执行相关模块的代码"><span class="toc_mobile_items-number">2.8.3.</span> <span class="toc_mobile_items-text">③通过__webpack_require__执行相关模块的代码</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#总结"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">总结</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#写在最后"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">写在最后</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#参考链接"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">参考链接</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目錄</div><div class="sidebar-toc__progress"><span class="progress-notice">你已經讀了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#热更新实现原理"><span class="toc-number">2.</span> <span class="toc-text">热更新实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-webpack-dev-server启动本地服务"><span class="toc-number">2.1.</span> <span class="toc-text">1. webpack-dev-server启动本地服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-修改webpack-config-js的entry配置"><span class="toc-number">2.2.</span> <span class="toc-text">2. 修改webpack.config.js的entry配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-监听webpack编译结束"><span class="toc-number">2.3.</span> <span class="toc-text">3. 监听webpack编译结束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-webpack监听文件变化"><span class="toc-number">2.4.</span> <span class="toc-text">4. webpack监听文件变化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-浏览器接收到热更新的通知"><span class="toc-number">2.5.</span> <span class="toc-text">5. 浏览器接收到热更新的通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-HotModuleReplacementPlugin"><span class="toc-number">2.6.</span> <span class="toc-text">6. HotModuleReplacementPlugin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-moudle-hot-check-开始热更新"><span class="toc-number">2.7.</span> <span class="toc-text">7. moudle.hot.check 开始热更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-hotApply-热更新模块替换"><span class="toc-number">2.8.</span> <span class="toc-text">8. hotApply 热更新模块替换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#①删除过期的模块，就是需要替换的模块"><span class="toc-number">2.8.1.</span> <span class="toc-text">①删除过期的模块，就是需要替换的模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#②将新的模块添加到-modules-中"><span class="toc-number">2.8.2.</span> <span class="toc-text">②将新的模块添加到 modules 中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#③通过-webpack-require-执行相关模块的代码"><span class="toc-number">2.8.3.</span> <span class="toc-text">③通过__webpack_require__执行相关模块的代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#写在最后"><span class="toc-number">4.</span> <span class="toc-text">写在最后</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考链接"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://z3.ax1x.com/2021/03/24/6b40k4.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">webpack热更新原理</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 發表於 2021-03-24<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新於 2021-03-24</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/技术/">技术</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字數總計:</span><span class="word-count">4.1k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>閲讀時長: 14 分鐘</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>閲讀量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>Hot Module Replacement，简称HMR，无需完全刷新整个页面的同时，更新模块。HMR的好处，在日常开发工作中体会颇深：节省宝贵的开发时间、提升开发体验。</p>
</blockquote>
<p>通常我们可以通过 <code>HotModuleReplacementPlugin</code> 或 启动指令增加参数 <code>--hot</code> 来启用热更新。</p>
<p>如果不关心细节只想知道热更新的大概流程，请直接拉到文章末尾 <code>总结</code> 。</p>
<p><strong>HMR是如何实现热更新的呢？下面一步步拆分介绍</strong></p>
<h2 id="热更新实现原理"><a href="#热更新实现原理" class="headerlink" title="热更新实现原理"></a>热更新实现原理</h2><h3 id="1-webpack-dev-server启动本地服务"><a href="#1-webpack-dev-server启动本地服务" class="headerlink" title="1. webpack-dev-server启动本地服务"></a>1. webpack-dev-server启动本地服务</h3><p>我们根据<code>webpack-dev-server</code>的<code>package.json</code>中的<code>bin</code>命令，可以找到命令的入口文件<code>bin/webpack-dev-server.js</code>。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node_modules/webpack-dev-server/bin/webpack-dev-server.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成webpack编译主引擎 compiler</span></span><br><span class="line"><span class="keyword">let</span> compiler = webpack(config);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动本地服务</span></span><br><span class="line"><span class="keyword">let</span> server = <span class="keyword">new</span> Server(compiler, options, log);</span><br><span class="line">server.listen(options.port, options.host, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;<span class="keyword">throw</span> err&#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div>
<p>本地服务代码：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node_modules/webpack-dev-server/lib/Server.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>.setupApp();</span><br><span class="line">        <span class="keyword">this</span>.createServer();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    setupApp() &#123;</span><br><span class="line">        <span class="comment">// 依赖了express</span></span><br><span class="line">    	<span class="keyword">this</span>.app = <span class="keyword">new</span> express();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createServer() &#123;</span><br><span class="line">        <span class="keyword">this</span>.listeningApp = http.createServer(<span class="keyword">this</span>.app);</span><br><span class="line">    &#125;</span><br><span class="line">    listen(port, hostname, fn) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.listeningApp.listen(port, hostname, (err) =&gt; &#123;</span><br><span class="line">            <span class="comment">// 启动express服务后，启动websocket服务</span></span><br><span class="line">            <span class="keyword">this</span>.createSocketServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;                                   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>这一小节代码主要做了三件事：</p>
<ul>
<li>启动<code>webpack</code>，生成<code>compiler</code>实例。<code>compiler</code>上有很多方法，比如可以启动 <code>webpack</code> 所有<strong>编译</strong>工作，以及<strong>监听</strong>本地文件的变化。</li>
<li>使用<code>express</code>框架启动本地<code>server</code>，让浏览器可以请求本地的<strong>静态资源</strong>。</li>
<li>本地<code>server</code>启动之后，再去启动<code>websocket</code>服务，如果不了解<code>websocket</code>，建议简单了解一下<a href="https://www.ruanyifeng.com/blog/2017/05/websocket.html" target="_blank" rel="noopener">websocket速成</a>。通过<code>websocket</code>，可以建立本地服务和浏览器的双向通信。这样就可以实现当本地文件发生变化，立马告知浏览器可以热更新代码啦！</li>
</ul>
<p>上述代码主要干了三件事，但是源码在启动服务前又做了很多事，接下来便看看<code>webpack-dev-server/lib/Server.js</code>还做了哪些事？</p>
<h3 id="2-修改webpack-config-js的entry配置"><a href="#2-修改webpack-config-js的entry配置" class="headerlink" title="2. 修改webpack.config.js的entry配置"></a>2. 修改webpack.config.js的entry配置</h3><p>启动本地服务前，调用了<code>updateCompiler(this.compiler)</code>方法。这个方法中有 2 段关键性代码。一个是获取<code>websocket</code>客户端代码路径，另一个是根据配置获取<code>webpack</code>热更新代码路径。<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取websocket客户端代码</span></span><br><span class="line"><span class="keyword">const</span> clientEntry = <span class="string">`<span class="subst">$&#123;<span class="built_in">require</span>.resolve(</span></span></span><br><span class="line"><span class="string"><span class="subst">    <span class="string">'../../client/'</span></span></span></span><br><span class="line"><span class="string"><span class="subst">)&#125;</span>?<span class="subst">$&#123;domain&#125;</span><span class="subst">$&#123;sockHost&#125;</span><span class="subst">$&#123;sockPath&#125;</span><span class="subst">$&#123;sockPort&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据配置获取热更新代码</span></span><br><span class="line"><span class="keyword">let</span> hotEntry;</span><br><span class="line"><span class="keyword">if</span> (options.hotOnly) &#123;</span><br><span class="line">    hotEntry = <span class="built_in">require</span>.resolve(<span class="string">'webpack/hot/only-dev-server'</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.hot) &#123;</span><br><span class="line">    hotEntry = <span class="built_in">require</span>.resolve(<span class="string">'webpack/hot/dev-server'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>修改后的<code>webpack</code>入口配置如下：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改后的entry入口</span></span><br><span class="line">&#123; <span class="attr">entry</span>:</span><br><span class="line">    &#123; <span class="attr">index</span>: </span><br><span class="line">        [</span><br><span class="line">            <span class="comment">// 上面获取的clientEntry</span></span><br><span class="line">            <span class="string">'xxx/node_modules/webpack-dev-server/client/index.js?http://localhost:8080'</span>,</span><br><span class="line">            <span class="comment">// 上面获取的hotEntry</span></span><br><span class="line">            <span class="string">'xxx/node_modules/webpack/hot/dev-server.js'</span>,</span><br><span class="line">            <span class="comment">// 开发配置的入口</span></span><br><span class="line">            <span class="string">'./src/index.js'</span></span><br><span class="line">    	],</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>为什么要新增了 2 个文件？在入口默默增加了 2 个文件，那就意味会一同打包到<code>bundle</code>文件中去，也就是线上运行时。</p>
<p><strong>（1）webpack-dev-server/client/index.js</strong></p>
<p>首先这个文件用于<code>websocket</code>的，因为<code>websoket</code>是双向通信，如果不了解<code>websocket</code>，建议简单了解一下<a href="https://www.ruanyifeng.com/blog/2017/05/websocket.html" target="_blank" rel="noopener">websocket速成</a>。我们在第 1 步 <code>webpack-dev-server</code>初始化 的过程中，启动的是本地服务端的<code>websocket</code>。那客户端也就是我们的浏览器，浏览器还没有和服务端通信的代码呢？总不能让开发者去写吧hhhhhh。因此我们需要把<code>websocket</code>客户端通信代码偷偷塞到我们的代码中。客户端具体的代码后面会在合适的时机细讲哦。</p>
<p><strong>（2）webpack/hot/dev-server.js</strong></p>
<p>这个文件主要是用于检查更新逻辑的，这里大家知道就好，代码后面会在合适的时机（<strong>第5步</strong>）细讲。</p>
<h3 id="3-监听webpack编译结束"><a href="#3-监听webpack编译结束" class="headerlink" title="3. 监听webpack编译结束"></a>3. 监听webpack编译结束</h3><p>修改好入口配置后，又调用了<code>setupHooks</code>方法。这个方法是用来注册监听事件的，监听每次<code>webpack</code>编译完成。<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node_modules/webpack-dev-server/lib/Server.js</span></span><br><span class="line"><span class="comment">// 绑定监听事件</span></span><br><span class="line">setupHooks() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;done&#125; = compiler.hooks;</span><br><span class="line">    <span class="comment">// 监听webpack的done钩子，tapable提供的监听方法</span></span><br><span class="line">    done.tap(<span class="string">'webpack-dev-server'</span>, (stats) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>._sendStats(<span class="keyword">this</span>.sockets, <span class="keyword">this</span>.getStats(stats));</span><br><span class="line">        <span class="keyword">this</span>._stats = stats;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div></p>
<p>当监听到一次<code>webpack</code>编译结束，就会调用<code>_sendStats</code>方法通过<code>websocket</code>给浏览器发送通知，<code>ok</code>和<code>hash</code>事件，这样浏览器就可以拿到最新的<code>hash</code>值了，做检查更新逻辑。<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过websoket给客户端发消息</span></span><br><span class="line">_sendStats() &#123;</span><br><span class="line">    <span class="keyword">this</span>.sockWrite(sockets, <span class="string">'hash'</span>, stats.hash);</span><br><span class="line">    <span class="keyword">this</span>.sockWrite(sockets, <span class="string">'ok'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<h3 id="4-webpack监听文件变化"><a href="#4-webpack监听文件变化" class="headerlink" title="4. webpack监听文件变化"></a>4. webpack监听文件变化</h3><p>每次修改代码，就会触发编译。说明我们还需要监听本地代码的变化，主要是通过<code>setupDevMiddleware</code>方法实现的。</p>
<p>这个方法主要执行了<code>webpack-dev-middleware</code>库。很多人分不清<code>webpack-dev-middleware</code>和<code>webpack-dev-server</code>的区别。其实就是因为<code>webpack-dev-server</code>只负责启动服务和前置准备工作，所有文件相关的操作都抽离到<code>webpack-dev-middleware</code>库了，主要是本地文件的<strong>编译</strong>和<strong>输出</strong>以及<strong>监听</strong>，无非就是职责的划分更清晰了。</p>
<p>那我们来看下<code>webpack-dev-middleware</code>源码里做了什么事:<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node_modules/webpack-dev-middleware/index.js</span></span><br><span class="line">compiler.watch(options.watchOptions, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123; <span class="comment">/*错误处理*/</span> &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过“memory-fs”库将打包后的文件写入内存</span></span><br><span class="line">setFs(context, compiler);</span><br></pre></td></tr></table></figure></div></p>
<p>（1）调用了<code>compiler.watch</code>方法，在第 1 步中也提到过，<code>compiler</code>的强大。这个方法主要就做了 2 件事：</p>
<ul>
<li>首先对本地文件代码进行编译打包，也就是<code>webpack</code>的一系列编译流程。</li>
<li>其次编译结束后，开启对本地文件的监听，当文件发生变化，重新编译，编译完成之后继续监听。</li>
</ul>
<p>为什么代码的改动保存会自动编译，重新打包？这一系列的重新检测编译就归功于<code>compiler.watch</code>这个方法了。监听本地文件的变化主要是通过<strong>文件的生成时间</strong>是否有变化，这里就不细讲了。</p>
<p>（2）执行<code>setFs</code>方法，这个方法主要目的就是将编译后的文件打包到内存。这就是为什么在开发的过程中，你会发现<code>dist</code>目录没有打包后的代码，因为都在内存中。原因就在于访问内存中的代码比访问文件系统中的文件更快，而且也减少了代码写入文件的开销，这一切都归功于<code>memory-fs</code>。</p>
<h3 id="5-浏览器接收到热更新的通知"><a href="#5-浏览器接收到热更新的通知" class="headerlink" title="5. 浏览器接收到热更新的通知"></a>5. 浏览器接收到热更新的通知</h3><p>我们已经可以监听到文件的变化了，当文件发生变化，就触发重新编译。同时还监听了每次编译结束的事件。当监听到一次<code>webpack</code>编译结束，<code>_sendStats</code>方法就通过<code>websoket</code>给浏览器发送通知，检查下是否需要热更新。下面重点讲的就是<code>_sendStats</code>方法中的<code>ok</code>和<code>hash</code>事件都做了什么。</p>
<p>那浏览器是如何接收到<code>websocket</code>的消息呢？回忆下第 2 步骤增加的入口文件，也就是<code>websocket</code>客户端代码。</p>
<pre><code>&apos;xxx/node_modules/webpack-dev-server/client/index.js?http://localhost:8080&apos;
</code></pre><p>这个文件的代码会被打包到<code>bundle.js</code>中，运行在浏览器中。来看下这个文件的核心代码吧。<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack-dev-server/client/index.js</span></span><br><span class="line"><span class="keyword">var</span> socket = <span class="built_in">require</span>(<span class="string">'./socket'</span>);</span><br><span class="line"><span class="keyword">var</span> onSocketMessage = &#123;</span><br><span class="line">    hash: <span class="function"><span class="keyword">function</span> <span class="title">hash</span>(<span class="params">_hash</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 更新currentHash值</span></span><br><span class="line">        status.currentHash = _hash;</span><br><span class="line">    &#125;,</span><br><span class="line">    ok: <span class="function"><span class="keyword">function</span> <span class="title">ok</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        sendMessage(<span class="string">'Ok'</span>);</span><br><span class="line">        <span class="comment">// 进行更新检查等操作</span></span><br><span class="line">        reloadApp(options, status);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 连接服务地址socketUrl，?http://localhost:8080，本地服务地址</span></span><br><span class="line">socket(socketUrl, onSocketMessage);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reloadApp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (hot) &#123;</span><br><span class="line">        log.info(<span class="string">'[WDS] App hot update...'</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// hotEmitter其实就是EventEmitter的实例</span></span><br><span class="line">        <span class="keyword">var</span> hotEmitter = <span class="built_in">require</span>(<span class="string">'webpack/hot/emitter'</span>);</span><br><span class="line">        hotEmitter.emit(<span class="string">'webpackHotUpdate'</span>, currentHash);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p><code>socket</code>方法建立了<code>websocket</code>和服务端的连接，并注册了 2 个监听事件。</p>
<ul>
<li><code>hash</code>事件，更新最新一次打包后的<code>hash</code>值。</li>
<li><code>ok</code>事件，进行热更新检查。</li>
</ul>
<p>热更新检查事件是调用<code>reloadApp</code>方法。比较奇怪的是，这个方法又利用<code>node.js</code>的<code>EventEmitter</code>，发出<code>webpackHotUpdate</code>消息。这是为什么？为什么不直接进行检查更新呢？</p>
<p>个人理解就是为了更好的维护代码，以及职责划分的更明确。<code>websocket</code>仅仅用于客户端（浏览器）和服务端进行通信。而真正做事情的活还是交回给了<code>webpack</code>。</p>
<p>那<code>webpack</code>怎么做的呢？再来回忆下第 2 步。入口文件还有一个文件没有讲到，就是：</p>
<pre><code>&apos;xxx/node_modules/webpack/hot/dev-server.js&apos;
</code></pre><p>这个文件的代码同样会被打包到<code>bundle.js</code>中，运行在浏览器中。这个文件做了什么就显而易见了吧！先瞄一眼代码：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node_modules/webpack/hot/dev-server.js</span></span><br><span class="line"><span class="keyword">var</span> check = <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">module</span>.hot.check(<span class="literal">true</span>)</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span>(<span class="params">updatedModules</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 容错，直接刷新页面</span></span><br><span class="line">            <span class="keyword">if</span> (!updatedModules) &#123;</span><br><span class="line">                <span class="built_in">window</span>.location.reload();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 热更新结束，打印信息</span></span><br><span class="line">            <span class="keyword">if</span> (upToDate()) &#123;</span><br><span class="line">                log(<span class="string">"info"</span>, <span class="string">"[HMR] App is up to date."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">        .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">window</span>.location.reload();</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hotEmitter = <span class="built_in">require</span>(<span class="string">"./emitter"</span>);</span><br><span class="line">hotEmitter.on(<span class="string">"webpackHotUpdate"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">currentHash</span>) </span>&#123;</span><br><span class="line">    lastHash = currentHash;</span><br><span class="line">    check();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div></p>
<p>这里<code>webpack</code>监听到了<code>webpackHotUpdate</code>事件，并获取最新了最新的<code>hash</code>值，然后终于进行检查更新了。检查更新呢调用的是<code>module.hot.check</code>方法。那么问题又来了，<code>module.hot.check</code>又是哪里冒出来了的！答案是<code>HotModuleReplacementPlugin</code>搞得鬼。这里留个疑问，继续往下看。</p>
<h3 id="6-HotModuleReplacementPlugin"><a href="#6-HotModuleReplacementPlugin" class="headerlink" title="6. HotModuleReplacementPlugin"></a>6. HotModuleReplacementPlugin</h3><p>前面好像一直是<code>webpack-dev-server</code>做的事，那<code>HotModuleReplacementPlugin</code>在热更新过程中又做了什么伟大的事业呢？</p>
<p>首先你可以对比下，配置热更新和不配置时<code>bundle.js</code>的区别。内存中看不到？直接执行<code>webpack</code>命令就可以看到生成的<code>bundle.js</code>文件啦。不要用<code>webpack-dev-server</code>启动就好了。</p>
<p>（1）没有配置的。</p>
<p><a href="https://user-gold-cdn.xitu.io/2019/12/1/16ec0c9e8fd12349?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-fancybox="group" data-caption class="fancybox"><img src="https://user-gold-cdn.xitu.io/2019/12/1/16ec0c9e8fd12349?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt title></a></p>
<p>（2）配置了<code>HotModuleReplacementPlugin</code>或<code>--hot</code>的。</p>
<p><a href="https://user-gold-cdn.xitu.io/2019/12/1/16ec0c90092fa0ac?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-fancybox="group" data-caption class="fancybox"><img src="https://user-gold-cdn.xitu.io/2019/12/1/16ec0c90092fa0ac?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt title></a></p>
<p>哦~ 我们发现<code>moudle</code>新增了一个属性为<code>hot</code>，再看<code>hotCreateModule</code>方法。 这不就找到<code>module.hot.check</code>是哪里冒出来的。</p>
<p><a href="https://user-gold-cdn.xitu.io/2019/12/1/16ec0dc36018973f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-fancybox="group" data-caption class="fancybox"><img src="https://user-gold-cdn.xitu.io/2019/12/1/16ec0dc36018973f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt title></a></p>
<p>经过对比打包后的文件，<code>__webpack_require__</code>中的<code>moudle</code>以及代码行数的不同。我们都可以发现<code>HotModuleReplacementPlugin</code>原来也是默默的塞了很多代码到<code>bundle.js</code>中呀。这和第 2 步骤很是相似哦！为什么，因为检查更新是在浏览器中操作呀。这些代码必须在运行时的环境。</p>
<p>你也可以直接看浏览器<code>Sources</code>下的代码，会发现<code>webpack</code>和<code>plugin</code>偷偷加的代码都在哦。在这里调试也很方便。</p>
<p><code>HotModuleReplacementPlugin</code>如何做到的？这里我就不讲了，因为这需要你对<code>tapable</code>以及<code>plugin</code>机制有一定了解，可以看下我写的文章<a href="https://juejin.im/post/6844904004435050503" target="_blank" rel="noopener">Webpack插件机制之Tapable-源码解析</a>。当然你也可以选择跳过，只关心热更新机制即可，毕竟信息量太大。</p>
<h3 id="7-moudle-hot-check-开始热更新"><a href="#7-moudle-hot-check-开始热更新" class="headerlink" title="7. moudle.hot.check 开始热更新"></a>7. moudle.hot.check 开始热更新</h3><p>通过第 6 步，我们就可以知道<code>moudle.hot.check</code>方法是如何来的啦。那都做了什么？之后的源码都是<code>HotModuleReplacementPlugin</code>塞入到<code>bundle.js</code>中的哦，我就不写文件路径了。</p>
<ul>
<li>利用上一次保存的<code>hash</code>值，调用<code>hotDownloadManifest</code>发送<code>xxx/hash.hot-update.json</code>的<code>ajax</code>请求；</li>
<li><p>请求结果获取热更新模块，以及下次热更新的<code>Hash</code> 标识，并进入热更新准备阶段。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hotAvailableFilesMap = update.c; <span class="comment">// 需要更新的文件</span></span><br><span class="line">hotUpdateNewHash = update.h; <span class="comment">// 更新下次热更新hash值</span></span><br><span class="line">hotSetStatus(<span class="string">"prepare"</span>); <span class="comment">// 进入热更新准备状态</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>调用<code>hotDownloadUpdateChunk</code>发送<code>xxx/hash.hot-update.js</code> 请求，通过<code>JSONP</code>方式。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hotDownloadUpdateChunk</span>(<span class="params">chunkId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">"script"</span>);</span><br><span class="line">    script.charset = <span class="string">"utf-8"</span>;</span><br><span class="line">    script.src = __webpack_require__.p + <span class="string">""</span> + chunkId + <span class="string">"."</span> + hotCurrentHash + <span class="string">".hot-update.js"</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span>) script.crossOrigin = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">document</span>.head.appendChild(script);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<p>这个函数体为什么要单独拿出来，因为这里要解释下为什么使用<code>JSONP</code>获取最新代码？主要是因为<code>JSONP</code>获取的代码可以直接执行。为什么要直接执行？我们来回忆下<code>/hash.hot-update.js</code>的代码格式是怎么样的。</p>
<p>新编译后的代码是在一个<code>webpackHotUpdate</code>函数体内部的。也就是要立即执行<code>webpackHotUpdate</code>这个方法。</p>
<p>再看下<code>webpackHotUpdate</code>这个方法。<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>[<span class="string">"webpackHotUpdate"</span>] = <span class="function"><span class="keyword">function</span> (<span class="params">chunkId, moreModules</span>) </span>&#123;</span><br><span class="line">    hotAddUpdateChunk(chunkId, moreModules);</span><br><span class="line">&#125; ;</span><br></pre></td></tr></table></figure></div></p>
<ul>
<li><code>hotAddUpdateChunk</code>方法会把更新的模块<code>moreModules</code>赋值给全局全量<code>hotUpdate</code>。</li>
<li><code>hotUpdateDownloaded</code>方法会调用<code>hotApply</code>进行代码的替换。<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hotAddUpdateChunk</span>(<span class="params">chunkId, moreModules</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 更新的模块moreModules赋值给全局全量hotUpdate</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> moduleId <span class="keyword">in</span> moreModules) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(moreModules, moduleId)) &#123;</span><br><span class="line">	    hotUpdate[moduleId] = moreModules[moduleId];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用hotApply进行模块的替换</span></span><br><span class="line">    hotUpdateDownloaded();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<h3 id="8-hotApply-热更新模块替换"><a href="#8-hotApply-热更新模块替换" class="headerlink" title="8. hotApply 热更新模块替换"></a>8. hotApply 热更新模块替换</h3><p>热更新的核心逻辑就在<code>hotApply</code>方法了。 <code>hotApply</code>代码有将近 400 行，还是挑重点讲了</p>
<h4 id="①删除过期的模块，就是需要替换的模块"><a href="#①删除过期的模块，就是需要替换的模块" class="headerlink" title="①删除过期的模块，就是需要替换的模块"></a>①删除过期的模块，就是需要替换的模块</h4><p>通过<code>hotUpdate</code>可以找到旧模块<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> queue = outdatedModules.slice();</span><br><span class="line"><span class="keyword">while</span> (queue.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    moduleId = queue.pop();</span><br><span class="line">    <span class="comment">// 从缓存中删除过期的模块</span></span><br><span class="line">    <span class="built_in">module</span> = installedModules[moduleId];</span><br><span class="line">    <span class="comment">// 删除过期的依赖</span></span><br><span class="line">    <span class="keyword">delete</span> outdatedDependencies[moduleId];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 存储了被删掉的模块id，便于更新代码</span></span><br><span class="line">    outdatedSelfAcceptedModules.push(&#123;</span><br><span class="line">        <span class="built_in">module</span>: moduleId</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<h4 id="②将新的模块添加到-modules-中"><a href="#②将新的模块添加到-modules-中" class="headerlink" title="②将新的模块添加到 modules 中"></a>②将新的模块添加到 modules 中</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">appliedUpdate[moduleId] = hotUpdate[moduleId];</span><br><span class="line"><span class="keyword">for</span> (moduleId <span class="keyword">in</span> appliedUpdate) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(appliedUpdate, moduleId)) &#123;</span><br><span class="line">        modules[moduleId] = appliedUpdate[moduleId];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="③通过-webpack-require-执行相关模块的代码"><a href="#③通过-webpack-require-执行相关模块的代码" class="headerlink" title="③通过__webpack_require__执行相关模块的代码"></a>③通过__webpack_require__执行相关模块的代码</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; outdatedSelfAcceptedModules.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> item = outdatedSelfAcceptedModules[i];</span><br><span class="line">    moduleId = item.module;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 执行最新的代码</span></span><br><span class="line">        __webpack_require__(moduleId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="comment">// ...容错处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><code>hotApply</code>的确比较复杂，知道大概流程就好了，这一小节，要求你对webpack打包后的文件如何执行的有一些了解，大家可以自去看下。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>webpack热更新原理概述</strong></p>
<p>分为两大步骤来实现</p>
<p>第一步：启动一个本地服务运行webpack。</p>
<p>第二步：增加打包入口配置，打包bundle文件并在浏览器上运行。</p>
<ol>
<li>webpack通过compiler.watch方法监听文件改动，并用compiler实例编译相关文件</li>
<li>webpack同时会监听编译完成的钩子，在回调中通过websocket发送消息到浏览器，通知浏览器更新资源。</li>
<li>浏览器收到消息后发起请求获取新资源，删除旧的资源，将新资源添加到modules上，最后利用<strong>webpack_require</strong>执行新资源代码</li>
</ol>
<p><strong>具体实现步骤</strong></p>
<ul>
<li><p>一、使用webpack-dev-server启动本地服务</p>
<ol>
<li>启动webpack生成compiler实例，compiler主要用于监听本地文件变化和编译工作</li>
<li>启动本地服务，让浏览器可访问本地静态资源，主要依赖express库</li>
<li>启动websocket服务，建立浏览器和本地服务的双向通信</li>
</ol>
</li>
<li><p>二、监听编译结束</p>
<ol>
<li>利用<code>compiler.hooks</code>提供的<code>done</code>钩子来监听编译结束</li>
<li>利用websocket通知浏览器编译结束，并传递新的hash值，浏览器做检查更新逻辑</li>
</ol>
</li>
<li><p>三、使用webpack-dev-middleware库编译、输出、监听本地文件</p>
<ol>
<li>调用<code>compiler.watch</code>方法，对本地代码进行编译，结束后开启对本地文件的监听，当文件发生变化，重新编译，编译完成后继续监听</li>
<li>代码编译后，会使用memory-fs库将编译好的文件存放在内存中，这是因为访问内存中的代码比访问系统文件更快，同时也减少了写入文件的开销</li>
</ol>
</li>
<li><p>四、浏览器接收热更新通知</p>
<ol>
<li>webpack会在entry增加入口，打包webpack运行时代码到<code>bundle.js</code>中，该部分代码运行在浏览器</li>
<li>bundle.js代码就是将HotModuleReplacementPlugin插件的代码塞进去</li>
<li>浏览器通过bundle.js发送ajax请求，请求需要更新的文件和hash值</li>
<li>通过HotModuleReplacementPlugin中的hotApply方法实现热更新模块替换。主要流程：删除过期模块、将新的模块添加module中、使用<strong>webpack_require</strong>执行相关模块代码</li>
</ol>
</li>
</ul>
<p>下面是以阅读源码的形式画的图，①-④的小标记，是文件发生变化的一个流程。</p>
<p><a href="https://user-gold-cdn.xitu.io/2019/12/1/16ec13499800dfce?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-fancybox="group" data-caption class="fancybox"><img src="https://user-gold-cdn.xitu.io/2019/12/1/16ec13499800dfce?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt title></a></p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>本次是以阅读源码的方式讲解原理，是因为觉得热更新这块涉及的知识量比较多。所以知识把关键性代码拿出来，因为每一个块细节说起来都能写一篇文章了，大家可以自己对着源码再理解下。</p>
<p>还是建议提前了解以下知识会更好理解热更新：</p>
<ul>
<li><strong>websocket</strong>：<a href="https://www.ruanyifeng.com/blog/2017/05/websocket.html" target="_blank" rel="noopener">websocket基础知识了解</a></li>
<li>打包后的<code>bundle</code>文件如何运行的。</li>
<li><code>webpack</code>启动流程，<code>webpack</code>生命周期。</li>
<li><strong>tapable</strong>: <a href="https://juejin.im/post/6844904004435050503" target="_blank" rel="noopener">Webpack插件机制之Tapable-源码解析</a></li>
</ul>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="https://github.com/Jocs/jocs.github.io/issues/15" target="_blank" rel="noopener">Webpack Hot Module Replacement 的原理解析</a></li>
<li><a href="https://juejin.im/post/6844903953092591630" target="_blank" rel="noopener">看完这篇，面试再也不怕被问 Webpack 热更新</a></li>
</ul>
</div></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/webpack/">webpack    </a></div><div class="post_share"><div class="social-share" data-image="https://z3.ax1x.com/2021/03/24/6b40k4.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2021/03/22/http协议/"><img class="next_cover lazyload" data-src="https://z3.ax1x.com/2021/03/24/6b5p3n.md.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>http协议</span></div></a></div></nav></div></main><footer id="footer" style="background-image: url(https://z3.ax1x.com/2021/03/24/6b40k4.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2021 By 温富杰</div><div class="framework-info"><span>Power by </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div><div class="footer_custom_text">初次为人，大胆点</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="閲讀模式"></i><i class="fa fa-plus" id="font_plus" title="放大字體"></i><i class="fa fa-minus" id="font_minus" title="縮小字體"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="簡繁轉換" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜間模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="設置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目錄" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到頂部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>